<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<!-- Initialization -->
<script id="sap-ui-bootstrap" type="text/javascript" src="../../../../../resources/sap-ui-core.js"
	data-sap-ui-theme="sap_bluecrystal"></script>

<link rel="stylesheet" href="../../../../../resources/sap/ui/thirdparty/qunit.css" type="text/css" media="screen" />
<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/qunit.js"></script>
<script type="text/javascript" src="../../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
<script type="text/javascript" src="../../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>

<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/sinon.js"></script>
<!--[if IE]>
	<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/sinon-ie.js"></script>
<![endif]-->
<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/sinon-qunit.js"></script>

<!-- Fake Service Implementaton -->
<script src="analytics/o4aFakeService.js"></script>
<!-- The metadata Fake Content -->
<script src="analytics/o4aMetadata.js"></script>
<!-- Fake Service Document -->
<script src="analytics/TBA_ServiceDocument.js"></script>
<!-- Fake Service Content for NO batch Tests -->
<script src="analytics/TBA_NoBatch.js"></script>
<!-- Fake Data for the BATCH Tests -->
<script src="analytics/TBA_Batch_Contexts.js"></script>
<script src="analytics/TBA_Batch_ExpandCollapseToggle.js"></script>
<script src="analytics/TBA_Batch_Filter.js"></script>
<script src="analytics/TBA_Batch_Sort.js"></script>

<!-- Test functions -->
<script language="javascript">
	jQuery.sap.require("sap.ui.model.odata.ODataModel");
	jQuery.sap.require("sap.ui.model.analytics.ODataModelAdapter");
	jQuery.sap.require("sap.ui.model.analytics.TreeBindingAdapter");

	//start the fake service
	var sServiceURI = "http://o4aFakeService:8080/";
	o4aFakeService.fake({
		baseURI: sServiceURI
	});

	var oODataModel,
		oBinding;

	module("AnalyticalBinding without batch requests", {
		setup: function() {
			oODataModel = new sap.ui.model.odata.ODataModel(sServiceURI, true);
			sap.ui.model.analytics.ODataModelAdapter.apply(oODataModel);
			oBinding = new sap.ui.model.analytics.AnalyticalBinding(oODataModel, "/ActualPlannedCosts(P_ControllingArea='US01',P_CostCenter='100-1000',P_CostCenterTo='999-9999')/Results", null, [], [], {
				analyticalInfo: [{
					name: "CostCenter",
					grouped: true,
					inResult: false,
					sortOrder: "Ascending",
					sorted: false,
					total: false,
					visible: true
				}, {
					name: "CostElement",
					grouped: true,
					inResult: false,
					sortOrder: "Ascending",
					sorted: false,
					total: false,
					visible: true
				}, {
					name: "Currency",
					grouped: true,
					inResult: false,
					sortOrder: "Ascending",
					sorted: false,
					total: false,
					visible: true
				}, {
					name: "ActualCosts",
					grouped: false,
					inResult: false,
					sortOrder: "Ascending",
					sorted: false,
					total: true,
					visible: true
				}],
				useBatchRequests: false,
				numberOfExpandedLevels: 0
			});
			sap.ui.model.analytics.TreeBindingAdapter.apply(oBinding);
		}
	});

	asyncTest("initially getContexts", function() {
		oBinding.attachChange(handler1);
		var aContexts = oBinding.getContexts(0, 20, 100),
			oContext,
			oContextInfo;

		var iHandleCounter = 0;
		function handler1() {
			iHandleCounter++;

			//When no batch request is used two change events are send from the binding
			if (iHandleCounter < 2) return;

			oBinding.detachChange(handler1);
			aContexts = oBinding.getContexts(0, 20, 100);

			equal(aContexts.length, 10, "There is one root context and the first level with 9 contexts is expanded");

			oContext = aContexts[0];
			oContextInfo = oBinding.getContextInfo(0);

			equal(oContextInfo.sum, false, "Context has correct sum information");
			equal(oContextInfo.level, 1, "Context has correct level information");
			equal(oContextInfo.expanded, false, "Context has correct expanded information");
			equal(oContextInfo.parent, aContexts[9], "Context has correct parent information");
			equal(oContextInfo.childCount, 0, "Context has correct child count information");
			equal(oContextInfo.index, 0, "Context has correct index information");
			equal(oContextInfo.position, 0, "Context has correct position information");
			equal(oContext.getProperty("CostCenter"), "100-1000", "Context has correct value for CostCenter");
			equal(oContext.getProperty("CostElement"), undefined, "Context has correct value for CostCenter");
			equal(oContext.getProperty("ActualCosts"), "1588416", "Context has correct value for CostCenter");

			oContext = aContexts[4];
			oContextInfo = oBinding.getContextInfo(4);

			equal(oContextInfo.sum, false, "Context has correct sum information");
			equal(oContextInfo.level, 1, "Context has correct level information");
			equal(oContextInfo.expanded, false, "Context has correct expanded information");
			equal(oContextInfo.parent, aContexts[9], "Context has correct parent information");
			equal(oContextInfo.childCount, 0, "Context has correct child count information");
			equal(oContextInfo.index, 4, "Context has correct index information");
			equal(oContextInfo.position, 4, "Context has correct position information");
			equal(oContext.getProperty("CostCenter"), "200-3000", "Context has correct value for CostCenter");
			equal(oContext.getProperty("CostElement"), undefined, "Context has correct value for CostCenter");
			equal(oContext.getProperty("ActualCosts"), "1690110", "Context has correct value for CostCenter");

			oContext = aContexts[9];
			oContextInfo = oBinding.getContextInfo(9);

			equal(oContextInfo.sum, true, "Context has correct sum information");
			equal(oContextInfo.level, 0, "Context has correct level information");
			equal(oContextInfo.expanded, true, "Context has correct expanded information");
			equal(oContextInfo.parent, null, "Context has correct parent information");
			equal(oContextInfo.childCount, 0, "Context has correct child count information");
			equal(oContextInfo.index, 0, "Context has correct index information");
			equal(oContextInfo.position, 9, "Context has correct position information");
			equal(oContext.getProperty("CostCenter"), undefined, "Context has correct value for CostCenter");
			equal(oContext.getProperty("CostElement"), undefined, "Context has correct value for CostCenter");
			equal(oContext.getProperty("ActualCosts"), "11775332", "Context has correct value for CostCenter");

			start();
		}
	});

	asyncTest("expand/collapse/toggle", function() {
		oBinding.attachChange(handler0);
		var aContexts = oBinding.getContexts(0, 20, 100),
			oContext,
			oContextInfo;

		var iHandleCounter = 0;
		function handler0() {
			iHandleCounter++;

			//When no batch request is used two change events are send from the binding
			if (iHandleCounter < 2) return;

			oBinding.detachChange(handler0);
			aContexts = oBinding.getContexts(0, 20, 100);

			equal(aContexts.length, 10, "There is one root context and the first level with 9 contexts is expanded");

			oBinding.attachChange(handler1);
			oBinding.expand(0);
			oBinding.getContexts(0, 20, 100);
		}

		function handler1() {
			oBinding.detachChange(handler1);
			aContexts = oBinding.getContexts(0, 20, 100);

			var oRootContext = oBinding.getContexts(oBinding.getLength() - 1, 1, 0)[0];

			equal(aContexts.length, 20, "There are 20 contexts");

			oContext = aContexts[0];
			oContextInfo = oBinding.getContextInfo(0);

			equal(oContextInfo.sum, false, "Context has correct sum information");
			equal(oContextInfo.level, 1, "Context has correct level information");
			equal(oContextInfo.expanded, true, "Context has correct expanded information");
			equal(oContextInfo.parent, oRootContext, "Context has correct parent information");
			equal(oContextInfo.childCount, 13, "Context has correct child count information");
			equal(oContextInfo.index, 0, "Context has correct index information");
			equal(oContextInfo.position, 0, "Context has correct position information");
			equal(oContext.getProperty("CostCenter"), "100-1000", "Context has correct value for CostCenter");
			equal(oContext.getProperty("CostElement"), undefined, "Context has correct value for CostCenter");
			equal(oContext.getProperty("ActualCosts"), "1588416", "Context has correct value for CostCenter");

			oContext = aContexts[1];
			oContextInfo = oBinding.getContextInfo(1);

			equal(oContextInfo.sum, false, "Context has correct sum information");
			equal(oContextInfo.level, 2, "Context has correct level information");
			equal(oContextInfo.expanded, false, "Context has correct expanded information");
			equal(oContextInfo.parent, aContexts[0], "Context has correct parent information");
			equal(oContextInfo.childCount, 0, "Context has correct child count information");
			equal(oContextInfo.index, 0, "Context has correct index information");
			equal(oContextInfo.position, 1, "Context has correct position information");
			equal(oContext.getProperty("CostCenter"), "100-1000", "Context has correct value for CostCenter");
			equal(oContext.getProperty("CostElement"), "400020", "Context has correct value for CostCenter");
			equal(oContext.getProperty("ActualCosts"), "131254", "Context has correct value for CostCenter");

			oContext = aContexts[13];
			oContextInfo = oBinding.getContextInfo(13);

			equal(oContextInfo.sum, true, "Context has correct sum information");
			equal(oContextInfo.level, 1, "Context has correct level information");
			equal(oContextInfo.expanded, false, "Context has correct expanded information");
			equal(oContextInfo.parent, aContexts[0], "Context has correct parent information");
			equal(oContextInfo.childCount, 0, "Context has correct child count information");
			equal(oContextInfo.index, 12, "Context has correct index information");
			equal(oContextInfo.position, 13, "Context has correct position information");
			equal(oContext.getProperty("CostCenter"), "100-1000", "Context has correct value for CostCenter");
			equal(oContext.getProperty("CostElement"), undefined, "Context has correct value for CostCenter");
			equal(oContext.getProperty("ActualCosts"), "1588416", "Context has correct value for CostCenter");

			oContext = aContexts[14];
			oContextInfo = oBinding.getContextInfo(14);

			equal(oContextInfo.sum, false, "Context has correct sum information");
			equal(oContextInfo.level, 1, "Context has correct level information");
			equal(oContextInfo.expanded, false, "Context has correct expanded information");
			equal(oContextInfo.parent, oRootContext, "Context has correct parent information");
			equal(oContextInfo.childCount, 0, "Context has correct child count information");
			equal(oContextInfo.index, 1, "Context has correct index information");
			equal(oContextInfo.position, 14, "Context has correct position information");
			equal(oContext.getProperty("CostCenter"), "100-1100", "Context has correct value for CostCenter");
			equal(oContext.getProperty("CostElement"), undefined, "Context has correct value for CostCenter");
			equal(oContext.getProperty("ActualCosts"), "1398408", "Context has correct value for CostCenter");

			oBinding.attachChange(handler2);
			oBinding.expand(1);
			oBinding.getContexts(0, 20, 100);
		}

		function handler2() {
			oBinding.detachChange(handler2);
			aContexts = oBinding.getContexts(0, 20, 100);

			var oRootContext = oBinding.getContexts(oBinding.getLength() - 1, 1, 0)[0];

			equal(aContexts.length, 20, "There are 20 contexts");

			oContext = aContexts[0];
			oContextInfo = oBinding.getContextInfo(0);

			equal(oContextInfo.sum, false, "Context has correct sum information");
			equal(oContextInfo.level, 1, "Context has correct level information");
			equal(oContextInfo.expanded, true, "Context has correct expanded information");
			equal(oContextInfo.parent, oRootContext, "Context has correct parent information");
			equal(oContextInfo.childCount, 14, "Context has correct child count information");
			equal(oContextInfo.index, 0, "Context has correct index information");
			equal(oContextInfo.position, 0, "Context has correct position information");
			equal(oContext.getProperty("CostCenter"), "100-1000", "Context has correct value for CostCenter");
			equal(oContext.getProperty("CostElement"), undefined, "Context has correct value for CostCenter");
			equal(oContext.getProperty("ActualCosts"), "1588416", "Context has correct value for CostCenter");

			oContext = aContexts[1];
			oContextInfo = oBinding.getContextInfo(1);

			equal(oContextInfo.sum, false, "Context has correct sum information");
			equal(oContextInfo.level, 2, "Context has correct level information");
			equal(oContextInfo.expanded, true, "Context has correct expanded information");
			equal(oContextInfo.parent, aContexts[0], "Context has correct parent information");
			equal(oContextInfo.childCount, 1, "Context has correct child count information");
			equal(oContextInfo.index, 0, "Context has correct index information");
			equal(oContextInfo.position, 1, "Context has correct position information");
			equal(oContext.getProperty("CostCenter"), "100-1000", "Context has correct value for CostCenter");
			equal(oContext.getProperty("CostElement"), "400020", "Context has correct value for CostCenter");
			equal(oContext.getProperty("ActualCosts"), "131254", "Context has correct value for CostCenter");

			oContext = aContexts[2];
			oContextInfo = oBinding.getContextInfo(2);

			equal(oContextInfo.sum, false, "Context has correct sum information");
			equal(oContextInfo.level, 3, "Context has correct level information");
			equal(oContextInfo.expanded, false, "Context has correct expanded information");
			equal(oContextInfo.parent, aContexts[1], "Context has correct parent information");
			equal(oContextInfo.childCount, 0, "Context has correct child count information");
			equal(oContextInfo.index, 0, "Context has correct index information");
			equal(oContextInfo.position, 2, "Context has correct position information");
			equal(oContext.getProperty("CostCenter"), "100-1000", "Context has correct value for CostCenter");
			equal(oContext.getProperty("CostElement"), "400020", "Context has correct value for CostCenter");
			equal(oContext.getProperty("ActualCosts"), "131254", "Context has correct value for CostCenter");

			oContext = aContexts[3];
			oContextInfo = oBinding.getContextInfo(3);

			equal(oContextInfo.sum, false, "Context has correct sum information");
			equal(oContextInfo.level, 2, "Context has correct level information");
			equal(oContextInfo.expanded, false, "Context has correct expanded information");
			equal(oContextInfo.parent, aContexts[0], "Context has correct parent information");
			equal(oContextInfo.childCount, 0, "Context has correct child count information");
			equal(oContextInfo.index, 1, "Context has correct index information");
			equal(oContextInfo.position, 3, "Context has correct position information");
			equal(oContext.getProperty("CostCenter"), "100-1000", "Context has correct value for CostCenter");
			equal(oContext.getProperty("CostElement"), "400021", "Context has correct value for CostCenter");
			equal(oContext.getProperty("ActualCosts"), "132025", "Context has correct value for CostCenter");

			oBinding.collapse(0);

			aContexts =  oBinding.getContexts(0, 20, 100);

			equal(aContexts.length, 10, "There are 10 contexts");

			oBinding.toggleIndex(0);

			aContexts = oBinding.getContexts(0, 20, 100);

			equal(aContexts.length, 20, "There are 20 contexts");

			oBinding.attachChange(handler3);
			oBinding.toggleIndex(3);
			oBinding.getContexts(0, 20, 100);
		}

		function handler3() {
			oBinding.detachChange(handler3);

			aContexts = oBinding.getContexts(0, 20, 100);

			equal(aContexts.length, 20, "There are 20 contexts");

			oContext = aContexts[4];
			oContextInfo = oBinding.getContextInfo(4);

			equal(oContextInfo.sum, false, "Context has correct sum information");
			equal(oContextInfo.level, 3, "Context has correct level information");
			equal(oContextInfo.expanded, false, "Context has correct expanded information");
			equal(oContextInfo.parent, aContexts[3], "Context has correct parent information");
			equal(oContextInfo.childCount, 0, "Context has correct child count information");
			equal(oContextInfo.index, 0, "Context has correct index information");
			equal(oContextInfo.position, 4, "Context has correct position information");
			equal(oContext.getProperty("CostCenter"), "100-1000", "Context has correct value for CostCenter");
			equal(oContext.getProperty("CostElement"), "410050", "Context has correct value for CostCenter");
			equal(oContext.getProperty("ActualCosts"), "44532", "Context has correct value for CostCenter");

			start();
		}

	});

	asyncTest("filter", function() {
		oBinding.attachChange(handler0);
		var aContexts = oBinding.getContexts(0, 20, 100),
			oContext,
			oContextInfo;

		var iHandleCounter = 0;
		function handler0() {
			iHandleCounter++;

			//When no batch request is used two change events are send from the binding
			if (iHandleCounter < 2) return;

			oBinding.detachChange(handler0);
			aContexts = oBinding.getContexts(0, 20, 100);

			equal(aContexts.length, 10, "There are 10 contexts");

			oBinding.filter([new sap.ui.model.Filter("CostCenter", "Contains", "100-")]);

			iHandleCounter = 0;
			oBinding.attachChange(handler1);
			aContexts = oBinding.getContexts(0, 20, 100);
		}

		function handler1() {
			iHandleCounter++;

			//When no batch request is used two change events are send from the binding
			if (iHandleCounter < 2) return;

			oBinding.detachChange(handler1);
			aContexts = oBinding.getContexts(0);

			equal(aContexts.length, 3, "There are 3 contexts");

			oContext = aContexts[0];
			oContextInfo = oBinding.getContextInfo(0);

			equal(oContextInfo.sum, false, "Context has correct sum information");
			equal(oContextInfo.level, 1, "Context has correct level information");
			equal(oContextInfo.expanded, false, "Context has correct expanded information");
			equal(oContextInfo.parent, aContexts[2], "Context has correct parent information");
			equal(oContextInfo.childCount, 0, "Context has correct child count information");
			equal(oContextInfo.index, 0, "Context has correct index information");
			equal(oContextInfo.position, 0, "Context has correct position information");
			equal(oContext.getProperty("CostCenter"), "100-1000", "Context has correct value for CostCenter");
			equal(oContext.getProperty("CostElement"), undefined, "Context has correct value for CostCenter");
			equal(oContext.getProperty("ActualCosts"), "1588416", "Context has correct value for CostCenter");

			oContext = aContexts[2];
			oContextInfo = oBinding.getContextInfo(2);

			equal(oContextInfo.sum, true, "Context has correct sum information");
			equal(oContextInfo.level, 0, "Context has correct level information");
			equal(oContextInfo.expanded, true, "Context has correct expanded information");
			equal(oContextInfo.parent, null, "Context has correct parent information");
			equal(oContextInfo.childCount, 0, "Context has correct child count information");
			equal(oContextInfo.index, 0, "Context has correct index information");
			equal(oContextInfo.position, 2, "Context has correct position information");
			equal(oContext.getProperty("CostCenter"), undefined, "Context has correct value for CostCenter");
			equal(oContext.getProperty("CostElement"), undefined, "Context has correct value for CostCenter");
			equal(oContext.getProperty("ActualCosts"), "2986824", "Context has correct value for CostCenter");

			start();
		}

	});

	asyncTest("sort", function() {
		oBinding.attachChange(handler0);
		var aContexts = oBinding.getContexts(0, 20, 100),
			oContext,
			oContextInfo;

		var iHandleCounter = 0;
		function handler0() {
			iHandleCounter++;

			//When no batch request is used two change events are send from the binding
			if (iHandleCounter < 2) return;

			oBinding.detachChange(handler0);
			aContexts = oBinding.getContexts(0, 20, 100);

			equal(aContexts.length, 10, "There are 10 contexts");

			oBinding.attachChange(handler1);
			oBinding.expand(0);
			oBinding.getContexts(0, 20, 100);
		}

		function handler1() {
			oBinding.detachChange(handler1);
			aContexts = oBinding.getContexts(0, 20, 100);

			var oRootContext = oBinding.getContexts(oBinding.getLength() - 1, 1, 0)[0];

			oContext = aContexts[0];
			oContextInfo = oBinding.getContextInfo(0);

			equal(oContextInfo.sum, false, "Context has correct sum information");
			equal(oContextInfo.level, 1, "Context has correct level information");
			equal(oContextInfo.expanded, true, "Context has correct expanded information");
			equal(oContextInfo.parent, oRootContext, "Context has correct parent information");
			equal(oContextInfo.childCount, 13, "Context has correct child count information");
			equal(oContextInfo.index, 0, "Context has correct index information");
			equal(oContextInfo.position, 0, "Context has correct position information");
			equal(oContext.getProperty("CostCenter"), "100-1000", "Context has correct value for CostCenter");
			equal(oContext.getProperty("CostElement"), undefined, "Context has correct value for CostCenter");
			equal(oContext.getProperty("ActualCosts"), "1588416", "Context has correct value for CostCenter");

			oContext = aContexts[1];
			oContextInfo = oBinding.getContextInfo(1);

			equal(oContextInfo.sum, false, "Context has correct sum information");
			equal(oContextInfo.level, 2, "Context has correct level information");
			equal(oContextInfo.expanded, false, "Context has correct expanded information");
			equal(oContextInfo.parent, aContexts[0], "Context has correct parent information");
			equal(oContextInfo.childCount, 0, "Context has correct child count information");
			equal(oContextInfo.index, 0, "Context has correct index information");
			equal(oContextInfo.position, 1, "Context has correct position information");
			equal(oContext.getProperty("CostCenter"), "100-1000", "Context has correct value for CostCenter");
			equal(oContext.getProperty("CostElement"), "400020", "Context has correct value for CostCenter");
			equal(oContext.getProperty("ActualCosts"), "131254", "Context has correct value for CostCenter");

			iHandleCounter = 0;
			oBinding.attachChange(handler2);
			oBinding.sort([new sap.ui.model.Sorter("CostCenter", true)]);
			oBinding.updateAnalyticalInfo([{
				name: "CostCenter",
				grouped: true,
				inResult: false,
				sortOrder: "Descending",
				sorted: true,
				total: false,
				visible: true
			}, {
				name: "CostElement",
				grouped: true,
				inResult: false,
				sortOrder: "Ascending",
				sorted: false,
				total: false,
				visible: true
			}, {
				name: "Currency",
				grouped: true,
				inResult: false,
				sortOrder: "Ascending",
				sorted: false,
				total: false,
				visible: true
			}, {
				name: "ActualCosts",
				grouped: false,
				inResult: false,
				sortOrder: "Ascending",
				sorted: false,
				total: true,
				visible: true
			}]);
			oBinding.getContexts(0, 20, 100);
		}

		function handler2() {
			iHandleCounter++;

			//When no batch request is used two change events are send from the binding
			if (iHandleCounter < 3) return;

			oBinding.detachChange(handler2);
			aContexts = oBinding.getContexts(0, 20, 100);

			var oRootContext = oBinding.getContexts(oBinding.getLength() - 1, 1, 0)[0];

			oContext = aContexts[0];
			oContextInfo = oBinding.getContextInfo(0);

			equal(oContextInfo.sum, false, "Context has correct sum information");
			equal(oContextInfo.level, 1, "Context has correct level information");
			equal(oContextInfo.expanded, false, "Context has correct expanded information");
			equal(oContextInfo.parent, oRootContext, "Context has correct parent information");
			equal(oContextInfo.childCount, 0, "Context has correct child count information");
			equal(oContextInfo.index, 0, "Context has correct index information");
			equal(oContextInfo.position, 0, "Context has correct position information");
			equal(oContext.getProperty("CostCenter"), "300-2000", "Context has correct value for CostCenter");
			equal(oContext.getProperty("CostElement"), undefined, "Context has correct value for CostCenter");
			equal(oContext.getProperty("ActualCosts"), "752475", "Context has correct value for CostCenter");

			oContext = aContexts[8];
			oContextInfo = oBinding.getContextInfo(8);

			equal(oContextInfo.sum, false, "Context has correct sum information");
			equal(oContextInfo.level, 1, "Context has correct level information");
			equal(oContextInfo.expanded, true, "Context has correct expanded information");
			equal(oContextInfo.parent, oRootContext, "Context has correct parent information");
			equal(oContextInfo.childCount, 13, "Context has correct child count information");
			equal(oContextInfo.index, 8, "Context has correct index information");
			equal(oContextInfo.position, 8, "Context has correct position information");
			equal(oContext.getProperty("CostCenter"), "100-1000", "Context has correct value for CostCenter");
			equal(oContext.getProperty("CostElement"), undefined, "Context has correct value for CostCenter");
			equal(oContext.getProperty("ActualCosts"), "1588416", "Context has correct value for CostCenter");

			oContext = aContexts[9];
			oContextInfo = oBinding.getContextInfo(9);

			equal(oContextInfo.sum, false, "Context has correct sum information");
			equal(oContextInfo.level, 2, "Context has correct level information");
			equal(oContextInfo.expanded, false, "Context has correct expanded information");
			equal(oContextInfo.parent, aContexts[8], "Context has correct parent information");
			equal(oContextInfo.childCount, 0, "Context has correct child count information");
			equal(oContextInfo.index, 0, "Context has correct index information");
			equal(oContextInfo.position, 9, "Context has correct position information");
			equal(oContext.getProperty("CostCenter"), "100-1000", "Context has correct value for CostCenter");
			equal(oContext.getProperty("CostElement"), "400020", "Context has correct value for CostCenter");
			equal(oContext.getProperty("ActualCosts"), "131254", "Context has correct value for CostCenter");
			start();
		}

	});

	module("AnalyticalBinding with batch requests", {
		setup: function() {
			oODataModel = new sap.ui.model.odata.ODataModel(sServiceURI, true);
			sap.ui.model.analytics.ODataModelAdapter.apply(oODataModel);
			oBinding = new sap.ui.model.analytics.AnalyticalBinding(oODataModel, "/ActualPlannedCosts(P_ControllingArea='US01',P_CostCenter='100-1000',P_CostCenterTo='999-9999')/Results", null, [], [], {
				analyticalInfo: [{
					name: "CostCenter",
					grouped: true,
					inResult: false,
					sortOrder: "Ascending",
					sorted: false,
					total: false,
					visible: true
				}, {
					name: "CostElement",
					grouped: true,
					inResult: false,
					sortOrder: "Ascending",
					sorted: false,
					total: false,
					visible: true
				}, {
					name: "Currency",
					grouped: true,
					inResult: false,
					sortOrder: "Ascending",
					sorted: false,
					total: false,
					visible: true
				}, {
					name: "ActualCosts",
					grouped: false,
					inResult: false,
					sortOrder: "Ascending",
					sorted: false,
					total: true,
					visible: true
				}],
				useBatchRequests: true,
				numberOfExpandedLevels: 0
			});
			sap.ui.model.analytics.TreeBindingAdapter.apply(oBinding);
		}
	});

	asyncTest("initially getContexts", function() {
		this.clock.restore();
		oBinding.attachChange(handler1);
		var aContexts = oBinding.getContexts(0, 20, 100),
			oContext,
			oContextInfo;

		function handler1() {
			oBinding.detachChange(handler1);
			aContexts = oBinding.getContexts(0, 20, 100);

			equal(aContexts.length, 10, "There is one root context and the first level with 9 contexts is expanded");

			oContext = aContexts[0];
			oContextInfo = oBinding.getContextInfo(0);

			equal(oContextInfo.sum, false, "Context has correct sum information");
			equal(oContextInfo.level, 1, "Context has correct level information");
			equal(oContextInfo.expanded, false, "Context has correct expanded information");
			equal(oContextInfo.parent, aContexts[9], "Context has correct parent information");
			equal(oContextInfo.childCount, 0, "Context has correct child count information");
			equal(oContextInfo.index, 0, "Context has correct index information");
			equal(oContextInfo.position, 0, "Context has correct position information");
			equal(oContext.getProperty("CostCenter"), "100-1000", "Context has correct value for CostCenter");
			equal(oContext.getProperty("CostElement"), undefined, "Context has correct value for CostCenter");
			equal(oContext.getProperty("ActualCosts"), "1588416", "Context has correct value for CostCenter");

			oContext = aContexts[4];
			oContextInfo = oBinding.getContextInfo(4);

			equal(oContextInfo.sum, false, "Context has correct sum information");
			equal(oContextInfo.level, 1, "Context has correct level information");
			equal(oContextInfo.expanded, false, "Context has correct expanded information");
			equal(oContextInfo.parent, aContexts[9], "Context has correct parent information");
			equal(oContextInfo.childCount, 0, "Context has correct child count information");
			equal(oContextInfo.index, 4, "Context has correct index information");
			equal(oContextInfo.position, 4, "Context has correct position information");
			equal(oContext.getProperty("CostCenter"), "200-3000", "Context has correct value for CostCenter");
			equal(oContext.getProperty("CostElement"), undefined, "Context has correct value for CostCenter");
			equal(oContext.getProperty("ActualCosts"), "1690110", "Context has correct value for CostCenter");

			oContext = aContexts[9];
			oContextInfo = oBinding.getContextInfo(9);

			equal(oContextInfo.sum, true, "Context has correct sum information");
			equal(oContextInfo.level, 0, "Context has correct level information");
			equal(oContextInfo.expanded, true, "Context has correct expanded information");
			equal(oContextInfo.parent, null, "Context has correct parent information");
			equal(oContextInfo.childCount, 0, "Context has correct child count information");
			equal(oContextInfo.index, 0, "Context has correct index information");
			equal(oContextInfo.position, 9, "Context has correct position information");
			equal(oContext.getProperty("CostCenter"), undefined, "Context has correct value for CostCenter");
			equal(oContext.getProperty("CostElement"), undefined, "Context has correct value for CostCenter");
			equal(oContext.getProperty("ActualCosts"), "11775332", "Context has correct value for CostCenter");

			start();
		}
	});

	asyncTest("expand/collapse/toggle.", function() {
		this.clock.restore();
		oBinding.attachChange(handler0);
		var aContexts = oBinding.getContexts(0, 20, 100),
			oContext,
			oContextInfo;

		function handler0() {

			oBinding.detachChange(handler0);
			aContexts = oBinding.getContexts(0, 20, 100);

			equal(aContexts.length, 10, "There is one root context and the first level with 9 contexts is expanded");

			oBinding.attachChange(handler1);
			oBinding.expand(0);
			oBinding.getContexts(0, 20, 100);
		}

		function handler1() {
			oBinding.detachChange(handler1);
			aContexts = oBinding.getContexts(0, 20, 100);

			var oRootContext = oBinding.getContexts(oBinding.getLength() - 1, 1, 0)[0];

			equal(aContexts.length, 20, "There are 20 contexts");

			oContext = aContexts[0];
			oContextInfo = oBinding.getContextInfo(0);

			equal(oContextInfo.sum, false, "Context has correct sum information");
			equal(oContextInfo.level, 1, "Context has correct level information");
			equal(oContextInfo.expanded, true, "Context has correct expanded information");
			equal(oContextInfo.parent, oRootContext, "Context has correct parent information");
			equal(oContextInfo.childCount, 13, "Context has correct child count information");
			equal(oContextInfo.index, 0, "Context has correct index information");
			equal(oContextInfo.position, 0, "Context has correct position information");
			equal(oContext.getProperty("CostCenter"), "100-1000", "Context has correct value for CostCenter");
			equal(oContext.getProperty("CostElement"), undefined, "Context has correct value for CostCenter");
			equal(oContext.getProperty("ActualCosts"), "1588416", "Context has correct value for CostCenter");

			oContext = aContexts[1];
			oContextInfo = oBinding.getContextInfo(1);

			equal(oContextInfo.sum, false, "Context has correct sum information");
			equal(oContextInfo.level, 2, "Context has correct level information");
			equal(oContextInfo.expanded, false, "Context has correct expanded information");
			equal(oContextInfo.parent, aContexts[0], "Context has correct parent information");
			equal(oContextInfo.childCount, 0, "Context has correct child count information");
			equal(oContextInfo.index, 0, "Context has correct index information");
			equal(oContextInfo.position, 1, "Context has correct position information");
			equal(oContext.getProperty("CostCenter"), "100-1000", "Context has correct value for CostCenter");
			equal(oContext.getProperty("CostElement"), "400020", "Context has correct value for CostCenter");
			equal(oContext.getProperty("ActualCosts"), "131254", "Context has correct value for CostCenter");

			oContext = aContexts[13];
			oContextInfo = oBinding.getContextInfo(13);

			equal(oContextInfo.sum, true, "Context has correct sum information");
			equal(oContextInfo.level, 1, "Context has correct level information");
			equal(oContextInfo.expanded, false, "Context has correct expanded information");
			equal(oContextInfo.parent, aContexts[0], "Context has correct parent information");
			equal(oContextInfo.childCount, 0, "Context has correct child count information");
			equal(oContextInfo.index, 12, "Context has correct index information");
			equal(oContextInfo.position, 13, "Context has correct position information");
			equal(oContext.getProperty("CostCenter"), "100-1000", "Context has correct value for CostCenter");
			equal(oContext.getProperty("CostElement"), undefined, "Context has correct value for CostCenter");
			equal(oContext.getProperty("ActualCosts"), "1588416", "Context has correct value for CostCenter");

			oContext = aContexts[14];
			oContextInfo = oBinding.getContextInfo(14);

			equal(oContextInfo.sum, false, "Context has correct sum information");
			equal(oContextInfo.level, 1, "Context has correct level information");
			equal(oContextInfo.expanded, false, "Context has correct expanded information");
			equal(oContextInfo.parent, oRootContext, "Context has correct parent information");
			equal(oContextInfo.childCount, 0, "Context has correct child count information");
			equal(oContextInfo.index, 1, "Context has correct index information");
			equal(oContextInfo.position, 14, "Context has correct position information");
			equal(oContext.getProperty("CostCenter"), "100-1100", "Context has correct value for CostCenter");
			equal(oContext.getProperty("CostElement"), undefined, "Context has correct value for CostCenter");
			equal(oContext.getProperty("ActualCosts"), "1398408", "Context has correct value for CostCenter");

			oBinding.attachChange(handler2);
			oBinding.expand(1);
			oBinding.getContexts(0, 20, 100);
		}

		function handler2() {
			oBinding.detachChange(handler2);
			aContexts = oBinding.getContexts(0, 20, 100);

			var oRootContext = oBinding.getContexts(oBinding.getLength() - 1, 1, 0)[0];

			equal(aContexts.length, 20, "There are 20 contexts");

			oContext = aContexts[0];
			oContextInfo = oBinding.getContextInfo(0);

			equal(oContextInfo.sum, false, "Context has correct sum information");
			equal(oContextInfo.level, 1, "Context has correct level information");
			equal(oContextInfo.expanded, true, "Context has correct expanded information");
			equal(oContextInfo.parent, oRootContext, "Context has correct parent information");
			equal(oContextInfo.childCount, 14, "Context has correct child count information");
			equal(oContextInfo.index, 0, "Context has correct index information");
			equal(oContextInfo.position, 0, "Context has correct position information");
			equal(oContext.getProperty("CostCenter"), "100-1000", "Context has correct value for CostCenter");
			equal(oContext.getProperty("CostElement"), undefined, "Context has correct value for CostCenter");
			equal(oContext.getProperty("ActualCosts"), "1588416", "Context has correct value for CostCenter");

			oContext = aContexts[1];
			oContextInfo = oBinding.getContextInfo(1);

			equal(oContextInfo.sum, false, "Context has correct sum information");
			equal(oContextInfo.level, 2, "Context has correct level information");
			equal(oContextInfo.expanded, true, "Context has correct expanded information");
			equal(oContextInfo.parent, aContexts[0], "Context has correct parent information");
			equal(oContextInfo.childCount, 1, "Context has correct child count information");
			equal(oContextInfo.index, 0, "Context has correct index information");
			equal(oContextInfo.position, 1, "Context has correct position information");
			equal(oContext.getProperty("CostCenter"), "100-1000", "Context has correct value for CostCenter");
			equal(oContext.getProperty("CostElement"), "400020", "Context has correct value for CostCenter");
			equal(oContext.getProperty("ActualCosts"), "131254", "Context has correct value for CostCenter");

			oContext = aContexts[2];
			oContextInfo = oBinding.getContextInfo(2);

			equal(oContextInfo.sum, false, "Context has correct sum information");
			equal(oContextInfo.level, 3, "Context has correct level information");
			equal(oContextInfo.expanded, false, "Context has correct expanded information");
			equal(oContextInfo.parent, aContexts[1], "Context has correct parent information");
			equal(oContextInfo.childCount, 0, "Context has correct child count information");
			equal(oContextInfo.index, 0, "Context has correct index information");
			equal(oContextInfo.position, 2, "Context has correct position information");
			equal(oContext.getProperty("CostCenter"), "100-1000", "Context has correct value for CostCenter");
			equal(oContext.getProperty("CostElement"), "400020", "Context has correct value for CostCenter");
			equal(oContext.getProperty("ActualCosts"), "131254", "Context has correct value for CostCenter");

			oContext = aContexts[3];
			oContextInfo = oBinding.getContextInfo(3);

			equal(oContextInfo.sum, false, "Context has correct sum information");
			equal(oContextInfo.level, 2, "Context has correct level information");
			equal(oContextInfo.expanded, false, "Context has correct expanded information");
			equal(oContextInfo.parent, aContexts[0], "Context has correct parent information");
			equal(oContextInfo.childCount, 0, "Context has correct child count information");
			equal(oContextInfo.index, 1, "Context has correct index information");
			equal(oContextInfo.position, 3, "Context has correct position information");
			equal(oContext.getProperty("CostCenter"), "100-1000", "Context has correct value for CostCenter");
			equal(oContext.getProperty("CostElement"), "400021", "Context has correct value for CostCenter");
			equal(oContext.getProperty("ActualCosts"), "132025", "Context has correct value for CostCenter");

			oBinding.collapse(0);

			aContexts =  oBinding.getContexts(0, 20, 100);

			equal(aContexts.length, 10, "There are 10 contexts");

			oBinding.toggleIndex(0);

			aContexts = oBinding.getContexts(0, 20, 100);

			equal(aContexts.length, 20, "There are 20 contexts");

			oBinding.attachChange(handler3);
			oBinding.toggleIndex(3);
			oBinding.getContexts(0, 20, 100);
		}

		function handler3() {
			oBinding.detachChange(handler3);

			aContexts = oBinding.getContexts(0, 20, 100);

			equal(aContexts.length, 20, "There are 20 contexts");

			oContext = aContexts[4];
			oContextInfo = oBinding.getContextInfo(4);

			equal(oContextInfo.sum, false, "Context has correct sum information");
			equal(oContextInfo.level, 3, "Context has correct level information");
			equal(oContextInfo.expanded, false, "Context has correct expanded information");
			equal(oContextInfo.parent, aContexts[3], "Context has correct parent information");
			equal(oContextInfo.childCount, 0, "Context has correct child count information");
			equal(oContextInfo.index, 0, "Context has correct index information");
			equal(oContextInfo.position, 4, "Context has correct position information");
			equal(oContext.getProperty("CostCenter"), "100-1000", "Context has correct value for CostCenter");
			equal(oContext.getProperty("CostElement"), "410050", "Context has correct value for CostCenter");
			equal(oContext.getProperty("ActualCosts"), "44532", "Context has correct value for CostCenter");

			start();
		}

	});

	asyncTest("filter", function() {
		this.clock.restore();
		oBinding.attachChange(handler0);
		var aContexts = oBinding.getContexts(0, 20, 100),
			oContext,
			oContextInfo;

		function handler0() {
			oBinding.detachChange(handler0);
			aContexts = oBinding.getContexts(0, 20, 100);

			equal(aContexts.length, 10, "There are 10 contexts");

			oBinding.filter([new sap.ui.model.Filter("CostCenter", "Contains", "100-")]);

			oBinding.attachChange(handler1);
			aContexts = oBinding.getContexts(0, 20, 100);
		}

		function handler1() {
			oBinding.detachChange(handler1);
			aContexts = oBinding.getContexts(0);

			equal(aContexts.length, 3, "There are 3 contexts");

			oContext = aContexts[0];
			oContextInfo = oBinding.getContextInfo(0);

			equal(oContextInfo.sum, false, "Context has correct sum information");
			equal(oContextInfo.level, 1, "Context has correct level information");
			equal(oContextInfo.expanded, false, "Context has correct expanded information");
			equal(oContextInfo.parent, aContexts[2], "Context has correct parent information");
			equal(oContextInfo.childCount, 0, "Context has correct child count information");
			equal(oContextInfo.index, 0, "Context has correct index information");
			equal(oContextInfo.position, 0, "Context has correct position information");
			equal(oContext.getProperty("CostCenter"), "100-1000", "Context has correct value for CostCenter");
			equal(oContext.getProperty("CostElement"), undefined, "Context has correct value for CostCenter");
			equal(oContext.getProperty("ActualCosts"), "1588416", "Context has correct value for CostCenter");

			oContext = aContexts[2];
			oContextInfo = oBinding.getContextInfo(2);

			equal(oContextInfo.sum, true, "Context has correct sum information");
			equal(oContextInfo.level, 0, "Context has correct level information");
			equal(oContextInfo.expanded, true, "Context has correct expanded information");
			equal(oContextInfo.parent, null, "Context has correct parent information");
			equal(oContextInfo.childCount, 0, "Context has correct child count information");
			equal(oContextInfo.index, 0, "Context has correct index information");
			equal(oContextInfo.position, 2, "Context has correct position information");
			equal(oContext.getProperty("CostCenter"), undefined, "Context has correct value for CostCenter");
			equal(oContext.getProperty("CostElement"), undefined, "Context has correct value for CostCenter");
			equal(oContext.getProperty("ActualCosts"), "2986824", "Context has correct value for CostCenter");

			start();
		}

	});

	asyncTest("sort", function() {
		this.clock.restore();
		oBinding.attachChange(handler0);
		var aContexts = oBinding.getContexts(0, 20, 100),
			oContext,
			oContextInfo;

		function handler0() {
			oBinding.detachChange(handler0);
			aContexts = oBinding.getContexts(0, 20, 100);

			equal(aContexts.length, 10, "There are 10 contexts");

			oBinding.attachChange(handler1);
			oBinding.expand(0);
			oBinding.getContexts(0, 20, 100);
		}

		function handler1() {
			oBinding.detachChange(handler1);
			aContexts = oBinding.getContexts(0, 20, 100);

			var oRootContext = oBinding.getContexts(oBinding.getLength() - 1, 1, 0)[0];

			oContext = aContexts[0];
			oContextInfo = oBinding.getContextInfo(0);

			equal(oContextInfo.sum, false, "Context has correct sum information");
			equal(oContextInfo.level, 1, "Context has correct level information");
			equal(oContextInfo.expanded, true, "Context has correct expanded information");
			equal(oContextInfo.parent, oRootContext, "Context has correct parent information");
			equal(oContextInfo.childCount, 13, "Context has correct child count information");
			equal(oContextInfo.index, 0, "Context has correct index information");
			equal(oContextInfo.position, 0, "Context has correct position information");
			equal(oContext.getProperty("CostCenter"), "100-1000", "Context has correct value for CostCenter");
			equal(oContext.getProperty("CostElement"), undefined, "Context has correct value for CostCenter");
			equal(oContext.getProperty("ActualCosts"), "1588416", "Context has correct value for CostCenter");

			oContext = aContexts[1];
			oContextInfo = oBinding.getContextInfo(1);

			equal(oContextInfo.sum, false, "Context has correct sum information");
			equal(oContextInfo.level, 2, "Context has correct level information");
			equal(oContextInfo.expanded, false, "Context has correct expanded information");
			equal(oContextInfo.parent, aContexts[0], "Context has correct parent information");
			equal(oContextInfo.childCount, 0, "Context has correct child count information");
			equal(oContextInfo.index, 0, "Context has correct index information");
			equal(oContextInfo.position, 1, "Context has correct position information");
			equal(oContext.getProperty("CostCenter"), "100-1000", "Context has correct value for CostCenter");
			equal(oContext.getProperty("CostElement"), "400020", "Context has correct value for CostCenter");
			equal(oContext.getProperty("ActualCosts"), "131254", "Context has correct value for CostCenter");

			iHandleCounter = 0;
			oBinding.attachChange(handler2);
			oBinding.sort([new sap.ui.model.Sorter("CostCenter", true)]);
			oBinding.updateAnalyticalInfo([{
				name: "CostCenter",
				grouped: true,
				inResult: false,
				sortOrder: "Descending",
				sorted: true,
				total: false,
				visible: true
			}, {
				name: "CostElement",
				grouped: true,
				inResult: false,
				sortOrder: "Ascending",
				sorted: false,
				total: false,
				visible: true
			}, {
				name: "Currency",
				grouped: true,
				inResult: false,
				sortOrder: "Ascending",
				sorted: false,
				total: false,
				visible: true
			}, {
				name: "ActualCosts",
				grouped: false,
				inResult: false,
				sortOrder: "Ascending",
				sorted: false,
				total: true,
				visible: true
			}]);
			oBinding.getContexts(0, 20, 100);
		}

		function handler2() {
			oBinding.detachChange(handler2);
			aContexts = oBinding.getContexts(0, 20, 100);

			var oRootContext = oBinding.getContexts(oBinding.getLength() - 1, 1, 0)[0];

			oContext = aContexts[0];
			oContextInfo = oBinding.getContextInfo(0);

			equal(oContextInfo.sum, false, "Context has correct sum information");
			equal(oContextInfo.level, 1, "Context has correct level information");
			equal(oContextInfo.expanded, false, "Context has correct expanded information");
			equal(oContextInfo.parent, oRootContext, "Context has correct parent information");
			equal(oContextInfo.childCount, 0, "Context has correct child count information");
			equal(oContextInfo.index, 0, "Context has correct index information");
			equal(oContextInfo.position, 0, "Context has correct position information");
			equal(oContext.getProperty("CostCenter"), "300-2000", "Context has correct value for CostCenter");
			equal(oContext.getProperty("CostElement"), undefined, "Context has correct value for CostCenter");
			equal(oContext.getProperty("ActualCosts"), "752475", "Context has correct value for CostCenter");

			oContext = aContexts[8];
			oContextInfo = oBinding.getContextInfo(8);

			equal(oContextInfo.sum, false, "Context has correct sum information");
			equal(oContextInfo.level, 1, "Context has correct level information");
			equal(oContextInfo.expanded, true, "Context has correct expanded information");
			equal(oContextInfo.parent, oRootContext, "Context has correct parent information");
			equal(oContextInfo.childCount, 13, "Context has correct child count information");
			equal(oContextInfo.index, 8, "Context has correct index information");
			equal(oContextInfo.position, 8, "Context has correct position information");
			equal(oContext.getProperty("CostCenter"), "100-1000", "Context has correct value for CostCenter");
			equal(oContext.getProperty("CostElement"), undefined, "Context has correct value for CostCenter");
			equal(oContext.getProperty("ActualCosts"), "1588416", "Context has correct value for CostCenter");

			oContext = aContexts[9];
			oContextInfo = oBinding.getContextInfo(9);

			equal(oContextInfo.sum, false, "Context has correct sum information");
			equal(oContextInfo.level, 2, "Context has correct level information");
			equal(oContextInfo.expanded, false, "Context has correct expanded information");
			equal(oContextInfo.parent, aContexts[8], "Context has correct parent information");
			equal(oContextInfo.childCount, 0, "Context has correct child count information");
			equal(oContextInfo.index, 0, "Context has correct index information");
			equal(oContextInfo.position, 9, "Context has correct position information");
			equal(oContext.getProperty("CostCenter"), "100-1000", "Context has correct value for CostCenter");
			equal(oContext.getProperty("CostElement"), "400020", "Context has correct value for CostCenter");
			equal(oContext.getProperty("ActualCosts"), "131254", "Context has correct value for CostCenter");
			start();
		}

	});

</script>

</head>
<body>
<h1 id="qunit-header">QUnit tests: sap.ui.model.analytics.TreeBindingAdapter</h1>
<h2 id="qunit-banner"></h2>
<h2 id="qunit-userAgent"></h2>
<div id="qunit-testrunner-toolbar"></div>
<ol id="qunit-tests"></ol>
</body>
</html>
